<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wits University: Color Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=VT323&display=swap" rel="stylesheet">
    <style>
        :root {
            --pixel-font: 'VT323', monospace;
            --main-font: 'Fredoka', sans-serif;
        }

        body {
            background-color: #0f172a;
            font-family: var(--main-font);
            overflow: hidden;
            touch-action: none;
            color: white;
            margin: 0;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background-color: #000;
        }

        canvas {
            width: 100%;
            height: 100%;
            image-rendering: pixelated; 
        }

        .ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
        }

        .quest-box {
            background: rgba(15, 23, 42, 0.9);
            border: 2px solid #3b82f6;
            padding: 16px;
            border-radius: 16px;
            backdrop-filter: blur(12px);
            min-width: 260px;
            pointer-events: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .bar-container {
            width: 100%; height: 16px; background: #334155;
            border-radius: 8px; margin-top: 8px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);
            position: relative;
        }
        .bar-fill { height: 100%; background: linear-gradient(90deg, #10b981, #34d399); transition: width 0.5s ease-in-out; }

        .dialog-box {
            background: white;
            border: 4px solid #3b82f6;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 120px; 
            pointer-events: auto;
            display: none;
            flex-direction: row;
            align-items: center;
            gap: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            max-width: 650px;
            width: 90%;
            align-self: center;
            animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .doodles-portrait {
            font-size: 50px; background: #eff6ff; border-radius: 50%;
            width: 80px; height: 80px; display: flex; justify-content: center;
            align-items: center; border: 4px solid #3b82f6; flex-shrink: 0;
        }

        .dialog-content { flex: 1; color: #1e293b; }
        .dialog-name { font-weight: 800; color: #2563eb; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; }
        .dialog-text { font-size: 1.15rem; line-height: 1.4; font-weight: 600; margin-top: 4px; }

        .next-btn {
            background: #2563eb; color: white; border: none;
            padding: 10px 24px; border-radius: 24px; cursor: pointer;
            font-weight: bold; margin-top: 12px; float: right;
            transition: transform 0.2s;
        }
        .next-btn:hover { transform: scale(1.05); }

        .controls-area {
            position: absolute; bottom: 30px; right: 30px;
            display: flex; gap: 20px; pointer-events: none;
        }

        .action-btn {
            width: 80px; height: 80px; border-radius: 50%;
            background: rgba(255,255,255,0.2); border: 3px solid white;
            display: flex; justify-content: center; align-items: center;
            font-size: 32px; backdrop-filter: blur(10px); cursor: pointer;
            pointer-events: auto; transition: all 0.2s;
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }
        
        .action-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.4); }

        .minimap {
            position: absolute; top: 20px; right: 20px; width: 160px; height: 160px;
            background: rgba(15, 23, 42, 0.85); border: 2px solid rgba(59, 130, 246, 0.5); border-radius: 16px;
        }

        .notification {
            position: absolute; top: 120px; left: 50%; transform: translateX(-50%);
            background: #2563eb; color: white; padding: 14px 28px;
            border-radius: 40px; font-weight: bold; display: none; z-index: 100;
            box-shadow: 0 15px 30px rgba(37, 99, 235, 0.3);
            border: 2px solid rgba(255,255,255,0.2);
        }

        .action-hint {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, 60px); background: #10b981;
            color: white; padding: 10px 20px; border-radius: 30px;
            font-weight: bold; display: none; z-index: 50;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .entrance-hint {
            position: absolute; top: 20%; left: 50%;
            transform: translateX(-50%); background: rgba(0,0,0,0.7);
            color: #fbbf24; padding: 8px 16px; border-radius: 8px;
            font-weight: bold; display: none; border: 1px solid #fbbf24;
        }

        .guide-text {
            color: #94a3b8; font-size: 0.75rem; margin-top: 8px; font-style: italic;
        }

        @keyframes slideUp { from { transform: translateY(60px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    
    <div class="ui-layer">
        <div class="flex justify-between w-full pointer-events-none">
            <div class="quest-box">
                <div class="flex justify-between items-center">
                    <span class="text-xs font-bold text-blue-400 uppercase tracking-widest">Campus Credits</span>
                    <span id="progressText" class="text-xs font-bold text-white">0/5</span>
                </div>
                <div class="bar-container">
                    <div id="xpBar" class="bar-fill" style="width: 0%"></div>
                </div>
                <div class="mt-3">
                    <div class="text-[10px] text-gray-400 uppercase font-bold">Current Quest</div>
                    <div id="questText" class="text-sm font-bold text-yellow-400">Talk to Doodles to start!</div>
                </div>
                <div class="guide-text">Follow the white paths to the gray doors!</div>
            </div>
            <canvas id="minimapCanvas" class="minimap"></canvas>
        </div>

        <div id="actionHint" class="action-hint">READY TO INTERACT (SPACE)</div>
        <div id="entranceHint" class="entrance-hint">ðŸšª ENTRANCE: Walk forward into the gray tile!</div>
        <div id="notification" class="notification">Item Collected!</div>

        <div id="dialogBox" class="dialog-box">
            <div class="doodles-portrait" id="portrait">ðŸ¦Š</div>
            <div class="dialog-content">
                <div id="dialogName" class="dialog-name">Doodles</div>
                <div id="dialogText" class="dialog-text">...</div>
                <button class="next-btn" onclick="advanceDialog()">NEXT â–¶</button>
            </div>
        </div>

        <div class="controls-area">
            <button class="action-btn" onclick="interact()">ðŸ’¬</button>
            <button class="action-btn" style="background: linear-gradient(135deg, #10b981, #059669);" onclick="interact()">ðŸ¤š</button>
        </div>
    </div>
</div>

<script>
/**
 * WITS UNIVERSITY: NO-AI MAJORS EDITION
 * FOCUS: ACCESSIBLE DOORWAYS AND PATHS
 */

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const miniCanvas = document.getElementById('minimapCanvas');
const miniCtx = miniCanvas.getContext('2d');

const RES_DIVISOR = 4;
const MAP_SIZE = 20;

const THEMES = {
    1: { main: '#8b5cf6', side: '#6d28d9', name: 'Quantum Physics' },
    2: { main: '#10b981', side: '#047857', name: 'Deep-Sea Ecology' },
    3: { main: '#3b82f6', side: '#1d4ed8', name: 'Astro-Engineering' },
    4: { main: '#475569', side: '#1e293b', name: 'Boundary' },
    5: { main: '#334155', side: '#1e293b', name: 'Doorway' }, 
    6: { main: '#f97316', side: '#c2410c', name: 'Experimental Arts' },
    7: { main: '#eab308', side: '#a16207', name: 'History of Sci' },
    8: { main: '#ef4444', side: '#b91c1c', name: 'Main Library' },
    9: { main: '#ec4899', side: '#be185d', name: 'Music Production' },
    10: { main: '#ffffff', side: '#cbd5e1', name: 'Guide Strip' } 
};

// WORLD MAP updated to ensure paths lead DIRECTLY to doorways (5)
const WORLD_MAP = [
    [4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4],
    [4,1,1,1,1,0,1,6,6,6,6,6,1,0,8,8,8,8,8,4],
    [4,1,0,0,1,0,6,0,0,0,0,0,6,0,8,0,0,0,8,4],
    [4,1,0,0,5,10,5,0,0,0,0,0,6,0,8,0,0,0,8,4], // Entry to Quantum (1,3) & Arts (6,3)
    [4,1,1,1,1,10,6,6,6,5,6,6,6,0,1,1,1,1,1,4], // Entry to Arts (9,4)
    [4,0,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,0,0,4],
    [4,0,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,0,0,4],
    [4,7,7,5,10,10,10,10,10,10,10,10,10,10,5,2,2,2,2,4], // Path connecting History (3,7) and Sea (14,7)
    [4,7,0,0,0,0,9,0,0,10,0,0,3,0,0,0,2,0,0,4],
    [4,7,7,7,5,10,5,4,4,10,4,4,5,10,5,2,2,2,2,4], // Entry to Music (6,9) and Astro (12,9)
    [4,0,0,0,0,10,10,10,10,10,10,10,10,10,0,0,0,0,0,4],
    [4,0,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,0,0,4],
    [4,4,4,0,0,10,0,0,0,10,0,0,0,10,0,0,0,4,4,4],
    [4,4,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,0,4,4],
    [4,8,8,5,10,10,0,0,0,10,0,0,0,10,10,5,8,8,8,4], // Library Entry (3,14)
    [4,8,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,0,8,4],
    [4,8,8,8,8,10,0,0,0,10,0,0,0,10,8,8,8,8,8,4],
    [4,4,4,0,0,10,0,0,0,10,0,0,0,10,0,0,0,4,4,4],
    [4,4,4,0,0,10,10,10,10,10,10,10,10,10,0,0,0,4,4,4],
    [4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4]
];

const state = {
    player: { x: 9.5, y: 17.5, dir: -Math.PI/2, plane: { x: 0.66, y: 0 } },
    input: { forward: false, backward: false, left: false, right: false },
    dialogQueue: [], isDialogActive: false,
    currentTarget: null,
    itemsCollected: 0,
    totalItems: 5,
    sprites: [
        { id: 'doodles', type: 'npc', name: 'Doodles', portrait: 'ðŸ¦Š', sprite: 'ðŸ¦Š', x: 9.5, y: 15.5, dialog: ["I've opened up the paths for you!", "The white guide strips on the floor now lead directly to the gray doors.", "Just follow the white path until you hit a dark gray wall, then walk through it!"] },
        { id: 'sign', type: 'npc', name: 'Info Sign', portrait: 'ðŸª§', sprite: 'ðŸª§', x: 7.5, y: 11.5, dialog: ["DOOR GUIDE: Follow white paths to reach gray doors.", "Physics: North-West", "Arts: North", "History: West", "Engineering: East", "Sea Ecology: Far East"] },
        { id: 'bot', type: 'npc', name: 'Guide Bot', portrait: 'ðŸ¤–', sprite: 'ðŸ¤–', x: 5.5, y: 5.5, dialog: ["The Blue building (Astro-Engineering) door is now right on the path!", "Quantum Physics (Purple) is much easier to reach now too."] },
        { type: 'item', name: 'Atomic Core', sprite: 'âš›ï¸', x: 2.5, y: 2.5 },
        { type: 'item', name: 'History Log', sprite: 'ðŸ“–', x: 2.5, y: 8.5 },
        { type: 'item', name: 'Golden Brush', sprite: 'ðŸ–Œï¸', x: 8.5, y: 2.5 },
        { type: 'item', name: 'Moon Stone', sprite: 'ðŸŒ‘', x: 12.5, y: 8.5 },
        { type: 'item', name: 'Ocean Pearl', sprite: 'âšª', x: 17.5, y: 8.5 }
    ]
};

function init() {
    resize();
    window.addEventListener('resize', resize);
    window.addEventListener('keydown', e => handleKey(e, true));
    window.addEventListener('keyup', e => handleKey(e, false));
    
    setTimeout(() => {
        queueDialog("Doodles", "I fixed the campus! Follow the white paths to find the doors.");
        updateQuest("Follow paths to find Campus Credits");
    }, 500);

    requestAnimationFrame(gameLoop);
}

function updateQuest(txt) {
    document.getElementById('questText').innerText = txt;
}

function updateProgress() {
    const percent = (state.itemsCollected / state.totalItems) * 100;
    document.getElementById('xpBar').style.width = percent + '%';
    document.getElementById('progressText').innerText = `${state.itemsCollected}/${state.totalItems}`;
    
    if (state.itemsCollected >= state.totalItems) {
        updateQuest("Return to Doodles to graduate!");
    } else {
        updateQuest(`Find Campus Credits (${state.itemsCollected}/${state.totalItems})`);
    }
}

function handleKey(e, isDown) {
    if (e.key === 'w' || e.code === 'ArrowUp') state.input.forward = isDown;
    if (e.key === 's' || e.code === 'ArrowDown') state.input.backward = isDown;
    if (e.key === 'a' || e.code === 'ArrowLeft') state.input.left = isDown;
    if (e.key === 'd' || e.code === 'ArrowRight') state.input.right = isDown;
    if (isDown && e.code === 'Space') interact();
}

function resize() {
    canvas.width = Math.ceil(window.innerWidth / RES_DIVISOR);
    canvas.height = Math.ceil(window.innerHeight / RES_DIVISOR);
}

function gameLoop() {
    if (!state.isDialogActive) {
        updateMovement();
        checkInteractions();
    }
    render();
    renderMinimap();
    requestAnimationFrame(gameLoop);
}

function updateMovement() {
    const p = state.player, speed = 0.08, rot = 0.05;
    const oldX = p.x, oldY = p.y;
    
    if (state.input.forward) { p.x += Math.cos(p.dir) * speed; p.y += Math.sin(p.dir) * speed; }
    if (state.input.backward) { p.x -= Math.cos(p.dir) * speed; p.y -= Math.sin(p.dir) * speed; }
    if (state.input.left) rotatePlayer(-rot);
    if (state.input.right) rotatePlayer(rot);
    
    const gridX = Math.floor(p.x);
    const gridY = Math.floor(p.y);
    
    if (gridY < 0 || gridY >= WORLD_MAP.length || gridX < 0 || gridX >= WORLD_MAP[0].length) {
        p.x = oldX; p.y = oldY;
    } else {
        const tile = WORLD_MAP[gridY][gridX];
        // Only block if it's a solid wall and NOT a doorway (5) or path (10) or air (0)
        if (tile > 0 && tile !== 10 && tile !== 5) {
            p.x = oldX; p.y = oldY;
        }
    }
}

function rotatePlayer(r) {
    const p = state.player;
    p.dir += r;
    const oldPlaneX = p.plane.x;
    p.plane.x = p.plane.x * Math.cos(r) - p.plane.y * Math.sin(r);
    p.plane.y = oldPlaneX * Math.sin(r) + p.plane.y * Math.cos(r);
}

function render() {
    const w = canvas.width, h = canvas.height, p = state.player;
    if (!w || !h) return;

    ctx.fillStyle = '#0f172a';
    ctx.fillRect(0, 0, w, h/2);
    ctx.fillStyle = '#1e293b';
    ctx.fillRect(0, h/2, w, h/2);
    
    const zBuffer = new Array(w);
    let seenDoor = false;
    
    for (let x = 0; x < w; x++) {
        const camX = 2 * x / w - 1;
        const rDirX = Math.cos(p.dir) + p.plane.x * camX;
        const rDirY = Math.sin(p.dir) + p.plane.y * camX;
        
        let mX = Math.floor(p.x), mY = Math.floor(p.y);
        const dX = Math.abs(1/rDirX), dY = Math.abs(1/rDirY);
        
        let sX, sY, sdX, sdY;
        if (rDirX < 0) { sX = -1; sdX = (p.x - mX) * dX; } else { sX = 1; sdX = (mX + 1 - p.x) * dX; }
        if (rDirY < 0) { sY = -1; sdY = (p.y - mY) * dY; } else { sY = 1; sdY = (mY + 1 - p.y) * dY; }
        
        let hit = 0, side, tile;
        let raySteps = 0;
        while(hit === 0 && raySteps < 50) {
            if (sdX < sdY) { sdX += dX; mX += sX; side = 0; } else { sdY += dY; mY += sY; side = 1; }
            if (mY < 0 || mY >= WORLD_MAP.length || mX < 0 || mX >= WORLD_MAP[0].length) {
                hit = 1; tile = 4;
            } else if (WORLD_MAP[mY][mX] > 0 && WORLD_MAP[mY][mX] !== 10) { 
                hit = 1; tile = WORLD_MAP[mY][mX]; 
            }
            raySteps++;
        }
        
        let dist = (side === 0) ? (mX - p.x + (1 - sX) / 2) / rDirX : (mY - p.y + (1 - sY) / 2) / rDirY;
        zBuffer[x] = dist;
        
        if (tile === 5 && dist < 2.5) seenDoor = true;

        const lh = Math.floor(h / dist);
        const theme = THEMES[tile] || THEMES[4];
        ctx.fillStyle = side === 1 ? theme.side : theme.main;
        
        ctx.globalAlpha = Math.min(1, 10 / dist);
        ctx.fillRect(x, h/2 - lh/2, 1, lh);
        ctx.globalAlpha = 1;
    }
    
    document.getElementById('entranceHint').style.display = seenDoor ? 'block' : 'none';
    renderSprites(zBuffer);
}

function renderSprites(zBuffer) {
    const w = canvas.width, h = canvas.height, p = state.player;
    const sorted = [...state.sprites].sort((a,b) => Math.hypot(b.x - p.x, b.y - p.y) - Math.hypot(a.x - p.x, a.y - p.y));

    sorted.forEach(s => {
        if (s.hidden) return;
        const sx = s.x - p.x, sy = s.y - p.y;
        const invDet = 1 / (p.plane.x * Math.sin(p.dir) - Math.cos(p.dir) * p.plane.y);
        const tx = invDet * (Math.sin(p.dir) * sx - Math.cos(p.dir) * sy);
        const ty = invDet * (-p.plane.y * sx + p.plane.x * sy);
        
        if (ty > 0.1) {
            const scX = Math.floor((w/2) * (1 + tx/ty));
            const sh = Math.abs(Math.floor(h/ty));
            if (scX >= 0 && scX < w && ty < zBuffer[scX]) {
                ctx.font = `${sh * 0.8}px serif`;
                ctx.textAlign = 'center';
                ctx.fillText(s.sprite, scX, h/2 + sh/3);
                
                if (s.type === 'item' || s.type === 'npc') {
                    ctx.font = `${sh * 0.15}px var(--main-font)`;
                    ctx.fillStyle = 'white';
                    ctx.fillText(s.name, scX, h/2 - sh/2);
                }
            }
        }
    });
}

function checkInteractions() {
    const p = state.player;
    let closest = null;
    let minDist = 1.8;
    
    state.sprites.forEach(s => {
        if (s.hidden) return;
        const d = Math.hypot(s.x - p.x, s.y - p.y);
        if (d < minDist) { closest = s; minDist = d; }
    });
    
    state.currentTarget = closest;
    document.getElementById('actionHint').style.display = closest ? 'block' : 'none';
}

function interact() {
    if (!state.currentTarget || state.isDialogActive) return;
    const s = state.currentTarget;
    if (s.type === 'npc') {
        document.getElementById('portrait').innerText = s.portrait;
        s.dialog.forEach(line => queueDialog(s.name, line));
        
        if (s.id === 'doodles' && state.itemsCollected >= state.totalItems) {
            queueDialog("Doodles", "Incredible! You've mastered all the departments.");
            queueDialog("Doodles", "You are officially a graduate of Wits University!");
            updateQuest("Graduated!");
        }
    } else if (s.type === 'item') {
        s.hidden = true;
        state.itemsCollected++;
        showNotification(`Collected: ${s.name}`);
        updateProgress();
        state.currentTarget = null;
    }
}

function queueDialog(n, t) {
    state.dialogQueue.push({n, t});
    if (!state.isDialogActive) advanceDialog();
}

function advanceDialog() {
    if (state.dialogQueue.length === 0) {
        state.isDialogActive = false;
        document.getElementById('dialogBox').style.display = 'none';
        return;
    }
    state.isDialogActive = true;
    const entry = state.dialogQueue.shift();
    document.getElementById('dialogBox').style.display = 'flex';
    document.getElementById('dialogName').innerText = entry.n;
    document.getElementById('dialogText').innerText = entry.t;
}

function showNotification(msg) {
    const el = document.getElementById('notification');
    el.innerText = msg;
    el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 3000);
}

function renderMinimap() {
    miniCtx.clearRect(0, 0, 160, 160);
    const scale = 8;
    for(let y=0; y<MAP_SIZE; y++) {
        for(let x=0; x<MAP_SIZE; x++) {
            const tile = WORLD_MAP[y][x];
            if (tile > 0 && tile !== 10) {
                miniCtx.fillStyle = THEMES[tile]?.main || '#444';
                miniCtx.fillRect(x*scale, y*scale, scale-1, scale-1);
            } else if (tile === 10) {
                miniCtx.fillStyle = 'rgba(255,255,255,0.3)';
                miniCtx.fillRect(x*scale, y*scale, scale-1, scale-1);
            }
        }
    }
    state.sprites.forEach(s => {
        if (s.type === 'item' && !s.hidden) {
            miniCtx.fillStyle = '#fbbf24';
            miniCtx.fillRect(s.x*scale-1, s.y*scale-1, 3, 3);
        }
    });
    miniCtx.fillStyle = '#3b82f6';
    miniCtx.beginPath();
    miniCtx.arc(state.player.x*scale, state.player.y*scale, 4, 0, Math.PI*2);
    miniCtx.fill();
    miniCtx.strokeStyle = 'white';
    miniCtx.lineWidth = 1;
    miniCtx.stroke();
}

init();
</script>
</body>
</html>
